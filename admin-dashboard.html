<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - ì°ë¶€ë¶€ AI í”„ë¡¬í”„íŠ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
        }
        
        .admin-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .admin-header p {
            opacity: 0.9;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1.5rem;
            border: 2px solid white;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            float: right;
        }
        
        .logout-btn:hover {
            background: white;
            color: #d97706;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #d97706;
            border-bottom-color: #d97706;
        }
        
        .tab:hover {
            color: #d97706;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #d97706;
        }
        
        .data-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f9fafb;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            font-weight: 600;
            color: #374151;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-admin {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-member {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-pending {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .badge-refunded {
            background: #fecaca;
            color: #991b1b;
        }
        
        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .action-btn-primary {
            background: #d97706;
            color: white;
        }
        
        .action-btn-primary:hover {
            background: #b45309;
        }
        
        .action-btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .action-btn-secondary:hover {
            background: #d1d5db;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }
        
        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            <h1>ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <p id="admin-info">ë¡œë”© ì¤‘...</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab" onclick="switchTab('community')">ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°</button>
            <button class="tab" onclick="switchTab('users')">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab('purchases')">ğŸ’° êµ¬ë§¤ ë‚´ì—­</button>
            <button class="tab" onclick="switchTab('payments')">ğŸ’³ ê²°ì œ ë‚´ì—­</button>
        </div>
        
        <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="stats-grid">
                <div class="loading">í†µê³„ ë¡œë”© ì¤‘...</div>
            </div>
            
            <h2 style="margin-bottom: 1rem;">ì¸ê¸° í”„ë¡¬í”„íŠ¸</h2>
            <div class="data-table">
                <table id="popular-prompts-table">
                    <thead>
                        <tr>
                            <th>í”„ë¡¬í”„íŠ¸</th>
                            <th>íŒë§¤ ìˆ˜</th>
                            <th>ë§¤ì¶œ</th>
                        </tr>
                    </thead>
                    <tbody id="popular-prompts-body">
                        <tr><td colspan="3" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ì»¤ë®¤ë‹ˆí‹° ê´€ë¦¬ íƒ­ -->
        <div id="community" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>ğŸ’¬ ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€ ê´€ë¦¬</h2>
                <button class="action-btn action-btn-primary" onclick="openPostModal()">
                    âœï¸ ìƒˆ ê²Œì‹œê¸€ ì‘ì„±
                </button>
            </div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ì œëª©</th>
                            <th>ì‘ì„±ì¼</th>
                            <th>ì´ë¯¸ì§€</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="community-posts-body">
                        <tr><td colspan="5" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
        <div id="users" class="tab-content">
            <h2 style="margin-bottom: 1rem;">ì „ì²´ ì‚¬ìš©ì</h2>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ì´ë¦„</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ê°€ì…ì¼</th>
                            <th>ê¶Œí•œ</th>
                            <th>êµ¬ë§¤</th>
                            <th>ì´ ì§€ì¶œ</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="users-body">
                        <tr><td colspan="9" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- êµ¬ë§¤ ë‚´ì—­ íƒ­ -->
        <div id="purchases" class="tab-content">
            <h2 style="margin-bottom: 1rem;">ìµœê·¼ êµ¬ë§¤ ë‚´ì—­ (100ê±´)</h2>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ì´ë©”ì¼</th>
                            <th>í”„ë¡¬í”„íŠ¸</th>
                            <th>ê¸ˆì•¡</th>
                            <th>êµ¬ë§¤ì¼ì‹œ</th>
                        </tr>
                    </thead>
                    <tbody id="purchases-body">
                        <tr><td colspan="6" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ê²°ì œ ë‚´ì—­ íƒ­ -->
        <div id="payments" class="tab-content">
            <h2 style="margin-bottom: 1rem;">ìµœê·¼ ê²°ì œ ë‚´ì—­ (100ê±´)</h2>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ê²°ì œìˆ˜ë‹¨</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ìƒíƒœ</th>
                            <th>ê²°ì œì¼ì‹œ</th>
                        </tr>
                    </thead>
                    <tbody id="payments-body">
                        <tr><td colspan="7" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '';
        
        // í† í° ê°€ì ¸ì˜¤ê¸°
        function getToken() {
            return localStorage.getItem('auth_token');
        }
        
        // API ìš”ì²­
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const token = getToken();
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }
            
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(API_BASE + endpoint, options);
            
            if (response.status === 403) {
                alert('â›” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'ìš”ì²­ ì‹¤íŒ¨');
            }
            
            return response.json();
        }
        
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // ë°ì´í„° ë¡œë“œ
            if (tabName === 'dashboard') loadDashboard();
            else if (tabName === 'community') loadCommunityPosts();
            else if (tabName === 'users') loadUsers();
            else if (tabName === 'purchases') loadPurchases();
            else if (tabName === 'payments') loadPayments();
        }
        
        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            try {
                const data = await apiRequest('/api/admin/dashboard');
                
                // ì •ì‚° ê³„ì¢Œ ì •ë³´ í‘œì‹œ
                const accountInfo = data.settlement_account;
                const accountHtml = `
                    <div class="data-table" style="margin-bottom: 2rem; background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);">
                        <h3 style="margin-bottom: 1rem; font-size: 1.25rem;">ğŸ’° ì •ì‚° ê³„ì¢Œ ì •ë³´</h3>
                        <div style="display: flex; gap: 2rem; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">ì€í–‰</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">${accountInfo.bank}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">ê³„ì¢Œë²ˆí˜¸</div>
                                <div style="font-size: 1.25rem; font-weight: 700; letter-spacing: 0.5px;">${accountInfo.account}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.25rem;">ì˜ˆê¸ˆì£¼</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">${accountInfo.holder}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // í†µê³„ ì¹´ë“œ ë Œë”ë§
                const statsHtml = `
                    <div class="stat-card">
                        <div class="stat-label">ì „ì²´ ì‚¬ìš©ì</div>
                        <div class="stat-value">${data.total_users.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">íšŒì›</div>
                        <div class="stat-value">${data.total_members.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ê´€ë¦¬ì</div>
                        <div class="stat-value">${data.total_admins.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ êµ¬ë§¤</div>
                        <div class="stat-value">${data.total_purchases.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ ë§¤ì¶œ</div>
                        <div class="stat-value">â‚©${data.total_revenue.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ê²Œì‹œê¸€</div>
                        <div class="stat-value">${data.total_posts.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ëŒ“ê¸€</div>
                        <div class="stat-value">${data.total_comments.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì™„ë£Œëœ ê²°ì œ</div>
                        <div class="stat-value">${data.total_payments.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì£¼ê°„ ì‹ ê·œ ê°€ì…</div>
                        <div class="stat-value">${data.new_users_week.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì£¼ê°„ ì‹ ê·œ êµ¬ë§¤</div>
                        <div class="stat-value">${data.new_purchases_week.toLocaleString()}</div>
                    </div>
                `;
                
                // ì •ì‚° ê³„ì¢Œ ì •ë³´ë¥¼ ë¨¼ì € í‘œì‹œí•˜ê³  ê·¸ ë‹¤ìŒ í†µê³„ ì¹´ë“œ í‘œì‹œ
                const container = document.getElementById('dashboard');
                const statsGrid = document.getElementById('stats-grid');
                
                // ì •ì‚° ê³„ì¢Œ ì •ë³´ê°€ ì•„ì§ ì—†ìœ¼ë©´ ì¶”ê°€
                if (!document.getElementById('account-info')) {
                    statsGrid.insertAdjacentHTML('beforebegin', accountHtml.replace('<div class="data-table"', '<div class="data-table" id="account-info"'));
                }
                
                statsGrid.innerHTML = statsHtml;
                
                // ì¸ê¸° í”„ë¡¬í”„íŠ¸
                const tbody = document.getElementById('popular-prompts-body');
                if (data.popular_prompts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">êµ¬ë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = data.popular_prompts.map(p => `
                        <tr>
                            <td>${p.title}</td>
                            <td>${p.sales_count}ê±´</td>
                            <td>â‚©${p.revenue.toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('stats-grid').innerHTML = `<div class="error-message">${error.message}</div>`;
            }
        }
        
        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadUsers() {
            try {
                const data = await apiRequest('/api/admin/users');
                const tbody = document.getElementById('users-body');
                
                if (data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = data.users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || '-'}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                ${user.is_admin ? '<span class="badge badge-admin">ê´€ë¦¬ì</span>' : ''}
                                ${user.is_member ? '<span class="badge badge-member">íšŒì›</span>' : ''}
                            </td>
                            <td>${user.purchase_count}ê±´</td>
                            <td>â‚©${user.total_spent.toLocaleString()}</td>
                            <td>
                                <button class="action-btn action-btn-primary" onclick="viewUser(${user.id})">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('users-body').innerHTML = `
                    <tr><td colspan="9" class="error-message">${error.message}</td></tr>
                `;
            }
        }
        
        // êµ¬ë§¤ ë‚´ì—­ ë¡œë“œ
        async function loadPurchases() {
            try {
                const data = await apiRequest('/api/admin/purchases');
                const tbody = document.getElementById('purchases-body');
                
                if (data.purchases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">êµ¬ë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = data.purchases.map(p => `
                        <tr>
                            <td>${p.id}</td>
                            <td>${p.username}</td>
                            <td>${p.email}</td>
                            <td>${p.prompt_title}</td>
                            <td>â‚©${p.price.toLocaleString()}</td>
                            <td>${p.purchased_at}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('êµ¬ë§¤ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('purchases-body').innerHTML = `
                    <tr><td colspan="6" class="error-message">${error.message}</td></tr>
                `;
            }
        }
        
        // ê²°ì œ ë‚´ì—­ ë¡œë“œ
        async function loadPayments() {
            try {
                const data = await apiRequest('/api/admin/payments');
                const tbody = document.getElementById('payments-body');
                
                if (data.payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = data.payments.map(p => `
                        <tr>
                            <td>${p.order_id}</td>
                            <td>${p.username}</td>
                            <td>${p.payment_method}</td>
                            <td>${p.item_name}</td>
                            <td>â‚©${p.amount.toLocaleString()}</td>
                            <td>
                                ${p.status === 'completed' ? '<span class="badge badge-completed">ì™„ë£Œ</span>' : ''}
                                ${p.status === 'pending' ? '<span class="badge badge-pending">ëŒ€ê¸°ì¤‘</span>' : ''}
                                ${p.status === 'refunded' ? '<span class="badge badge-refunded">í™˜ë¶ˆ</span>' : ''}
                            </td>
                            <td>${p.created_at}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('ê²°ì œ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('payments-body').innerHTML = `
                    <tr><td colspan="7" class="error-message">${error.message}</td></tr>
                `;
            }
        }
        
        // ì‚¬ìš©ì ìƒì„¸ë³´ê¸°
        async function viewUser(userId) {
            try {
                const user = await apiRequest(`/api/admin/users/${userId}`);
                alert(`ì‚¬ìš©ì ì •ë³´:\n\nì´ë¦„: ${user.username}\nì´ë©”ì¼: ${user.email}\nì „í™”ë²ˆí˜¸: ${user.phone || '-'}\nìƒë…„ì›”ì¼: ${user.birthdate || '-'}\nê°€ì…ì¼: ${user.created_at}\nì´ êµ¬ë§¤: ${user.purchases.length}ê±´\nì´ ì§€ì¶œ: â‚©${user.total_spent.toLocaleString()}`);
            } catch (error) {
                alert('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('auth_token');
                window.location.href = '/';
            }
        }
        
        // ì´ˆê¸°í™”
        async function init() {
            try {
                const user = await apiRequest('/api/user/me');
                document.getElementById('admin-info').textContent = `${user.user.username} (${user.user.email})`;
                
                // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
                loadDashboard();
            } catch (error) {
                alert('ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ' + error.message);
                window.location.href = '/';
            }
        }
        
        // ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€ ë¡œë“œ
        async function loadCommunityPosts() {
            try {
                const response = await fetch('/api/community/posts');
                const data = await response.json();
                const tbody = document.getElementById('community-posts-body');
                
                if (data.posts && data.posts.length > 0) {
                    tbody.innerHTML = data.posts.map(post => `
                        <tr>
                            <td>${post.id}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${post.title}</td>
                            <td>${new Date(post.created_at).toLocaleDateString()}</td>
                            <td>${post.image_url ? 'ğŸ“¸ ìˆìŒ' : '-'}</td>
                            <td>
                                <button class="action-btn action-btn-primary" onclick="editPost(${post.id})">
                                    âœï¸ ìˆ˜ì •
                                </button>
                                <button class="action-btn action-btn-danger" onclick="deletePost(${post.id})">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('community-posts-body').innerHTML = 
                    '<tr><td colspan="5" class="error-message">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
        
        // ê²Œì‹œê¸€ ì‘ì„± ëª¨ë‹¬ ì—´ê¸°
        function openPostModal(postData = null) {
            const title = postData ? 'âœï¸ ê²Œì‹œê¸€ ìˆ˜ì •' : 'âœï¸ ìƒˆ ê²Œì‹œê¸€ ì‘ì„±';
            const content = `
                <div style="padding: 2rem;">
                    <h3 style="margin-bottom: 1.5rem;">${title}</h3>
                    <form id="postForm" onsubmit="submitPost(event); return false;">
                        <input type="hidden" id="editPostId" value="${postData ? postData.id : ''}">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ì¹´í…Œê³ ë¦¬</label>
                            <select id="postCategory" required
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                <option value="ê³µì§€" ${postData && postData.category === 'ê³µì§€' ? 'selected' : ''}>ğŸ“¢ ê³µì§€</option>
                                <option value="ì§ˆë¬¸" ${postData && postData.category === 'ì§ˆë¬¸' ? 'selected' : ''}>â“ ê¶ê¸ˆí•œ ê²ƒ</option>
                                <option value="ììœ " ${postData && postData.category === 'ììœ ' ? 'selected' : ''}>ğŸ’¬ ììœ </option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ì œëª©</label>
                            <input type="text" id="postTitle" required 
                                   value="${postData ? postData.title : ''}"
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ë‚´ìš©</label>
                            <textarea id="postContent" required rows="6"
                                      style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; resize: vertical;">${postData ? postData.content : ''}</textarea>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ“¸ ì´ë¯¸ì§€ (ì„ íƒ)</label>
                            <input type="file" id="postImage" accept="image/*"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 8px;">
                            ${postData && postData.image_url ? `<div style="margin-top: 0.5rem;"><img src="${postData.image_url}" style="max-width: 200px; border-radius: 8px;"></div>` : ''}
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" onclick="closeCustomModal()" 
                                    style="padding: 0.75rem 1.5rem; border: 1px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">
                                ì·¨ì†Œ
                            </button>
                            <button type="submit" 
                                    style="padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                ${postData ? 'ìˆ˜ì •í•˜ê¸°' : 'ì‘ì„±í•˜ê¸°'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
            showCustomModal(content);
        }
        
        // ê²Œì‹œê¸€ ì œì¶œ
        async function submitPost(event) {
            event.preventDefault();
            
            const postId = document.getElementById('editPostId').value;
            const category = document.getElementById('postCategory').value;
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const imageFile = document.getElementById('postImage').files[0];
            
            const formData = new FormData();
            formData.append('category', category);
            formData.append('title', title);
            formData.append('content', content);
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            try {
                const url = postId ? `/api/community/posts/${postId}` : '/api/community/posts';
                const method = postId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(postId ? 'ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closeCustomModal();
                    loadCommunityPosts();
                } else {
                    alert(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì œì¶œ ì‹¤íŒ¨:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ê²Œì‹œê¸€ ìˆ˜ì •
        async function editPost(postId) {
            try {
                const response = await fetch(`/api/community/posts/${postId}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                const data = await response.json();
                
                if (response.ok) {
                    openPostModal(data.post);
                } else {
                    alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ê²Œì‹œê¸€ ì‚­ì œ
        async function deletePost(postId) {
            if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/community/posts/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadCommunityPosts();
                } else {
                    alert(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì»¤ìŠ¤í…€ ëª¨ë‹¬ í‘œì‹œ
        function showCustomModal(content) {
            const modal = document.createElement('div');
            modal.id = 'customModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            modal.innerHTML = `<div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">${content}</div>`;
            modal.onclick = function(e) {
                if (e.target === modal) closeCustomModal();
            };
            document.body.appendChild(modal);
        }
        
        // ì»¤ìŠ¤í…€ ëª¨ë‹¬ ë‹«ê¸°
        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            if (modal) modal.remove();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>
