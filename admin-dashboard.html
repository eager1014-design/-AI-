<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - ì°ë¶€ë¶€ AI í”„ë¡¬í”„íŠ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
        }
        
        .admin-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .admin-header p {
            opacity: 0.9;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1.5rem;
            border: 2px solid white;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            float: right;
        }
        
        .logout-btn:hover {
            background: white;
            color: #d97706;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #d97706;
            border-bottom-color: #d97706;
        }
        
        .tab:hover {
            color: #d97706;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #d97706;
        }
        
        .data-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f9fafb;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            font-weight: 600;
            color: #374151;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-admin {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-member {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-pending {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .badge-refunded {
            background: #fecaca;
            color: #991b1b;
        }
        
        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .action-btn-primary {
            background: #d97706;
            color: white;
        }
        
        .action-btn-primary:hover {
            background: #b45309;
        }
        
        .action-btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .action-btn-secondary:hover {
            background: #d1d5db;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }
        
        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            <h1>ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <p id="admin-info">ë¡œë”© ì¤‘...</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab" onclick="switchTab('users')">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
            <button class="tab" onclick="switchTab('purchases')">ğŸ’° êµ¬ë§¤ ë‚´ì—­</button>
            <button class="tab" onclick="switchTab('payments')">ğŸ’³ ê²°ì œ ë‚´ì—­</button>
        </div>
        
        <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="stats-grid">
                <div class="loading">í†µê³„ ë¡œë”© ì¤‘...</div>
            </div>
            
            <h2 style="margin-bottom: 1rem;">ì¸ê¸° í”„ë¡¬í”„íŠ¸</h2>
            <div class="data-table">
                <table id="popular-prompts-table">
                    <thead>
                        <tr>
                            <th>í”„ë¡¬í”„íŠ¸</th>
                            <th>íŒë§¤ ìˆ˜</th>
                            <th>ë§¤ì¶œ</th>
                        </tr>
                    </thead>
                    <tbody id="popular-prompts-body">
                        <tr><td colspan="3" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
        <div id="users" class="tab-content">
            <h2 style="margin-bottom: 1rem;">ì „ì²´ ì‚¬ìš©ì</h2>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ì´ë¦„</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ê°€ì…ì¼</th>
                            <th>ê¶Œí•œ</th>
                            <th>êµ¬ë§¤</th>
                            <th>ì´ ì§€ì¶œ</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="users-body">
                        <tr><td colspan="9" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- êµ¬ë§¤ ë‚´ì—­ íƒ­ -->
        <div id="purchases" class="tab-content">
            <h2 style="margin-bottom: 1rem;">ìµœê·¼ êµ¬ë§¤ ë‚´ì—­ (100ê±´)</h2>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ì´ë©”ì¼</th>
                            <th>í”„ë¡¬í”„íŠ¸</th>
                            <th>ê¸ˆì•¡</th>
                            <th>êµ¬ë§¤ì¼ì‹œ</th>
                        </tr>
                    </thead>
                    <tbody id="purchases-body">
                        <tr><td colspan="6" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ê²°ì œ ë‚´ì—­ íƒ­ -->
        <div id="payments" class="tab-content">
            <h2 style="margin-bottom: 1rem;">ìµœê·¼ ê²°ì œ ë‚´ì—­ (100ê±´)</h2>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ê²°ì œìˆ˜ë‹¨</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ìƒíƒœ</th>
                            <th>ê²°ì œì¼ì‹œ</th>
                        </tr>
                    </thead>
                    <tbody id="payments-body">
                        <tr><td colspan="7" class="loading">ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '';
        
        // í† í° ê°€ì ¸ì˜¤ê¸°
        function getToken() {
            return localStorage.getItem('auth_token');
        }
        
        // API ìš”ì²­
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const token = getToken();
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }
            
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(API_BASE + endpoint, options);
            
            if (response.status === 403) {
                alert('â›” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'ìš”ì²­ ì‹¤íŒ¨');
            }
            
            return response.json();
        }
        
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // ë°ì´í„° ë¡œë“œ
            if (tabName === 'dashboard') loadDashboard();
            else if (tabName === 'users') loadUsers();
            else if (tabName === 'purchases') loadPurchases();
            else if (tabName === 'payments') loadPayments();
        }
        
        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            try {
                const data = await apiRequest('/api/admin/dashboard');
                
                // í†µê³„ ì¹´ë“œ ë Œë”ë§
                const statsHtml = `
                    <div class="stat-card">
                        <div class="stat-label">ì „ì²´ ì‚¬ìš©ì</div>
                        <div class="stat-value">${data.total_users.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">íšŒì›</div>
                        <div class="stat-value">${data.total_members.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ê´€ë¦¬ì</div>
                        <div class="stat-value">${data.total_admins.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ êµ¬ë§¤</div>
                        <div class="stat-value">${data.total_purchases.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì´ ë§¤ì¶œ</div>
                        <div class="stat-value">â‚©${data.total_revenue.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ê²Œì‹œê¸€</div>
                        <div class="stat-value">${data.total_posts.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ëŒ“ê¸€</div>
                        <div class="stat-value">${data.total_comments.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì™„ë£Œëœ ê²°ì œ</div>
                        <div class="stat-value">${data.total_payments.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì£¼ê°„ ì‹ ê·œ ê°€ì…</div>
                        <div class="stat-value">${data.new_users_week.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì£¼ê°„ ì‹ ê·œ êµ¬ë§¤</div>
                        <div class="stat-value">${data.new_purchases_week.toLocaleString()}</div>
                    </div>
                `;
                
                document.getElementById('stats-grid').innerHTML = statsHtml;
                
                // ì¸ê¸° í”„ë¡¬í”„íŠ¸
                const tbody = document.getElementById('popular-prompts-body');
                if (data.popular_prompts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">êµ¬ë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = data.popular_prompts.map(p => `
                        <tr>
                            <td>${p.title}</td>
                            <td>${p.sales_count}ê±´</td>
                            <td>â‚©${p.revenue.toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('stats-grid').innerHTML = `<div class="error-message">${error.message}</div>`;
            }
        }
        
        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadUsers() {
            try {
                const data = await apiRequest('/api/admin/users');
                const tbody = document.getElementById('users-body');
                
                if (data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = data.users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || '-'}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                ${user.is_admin ? '<span class="badge badge-admin">ê´€ë¦¬ì</span>' : ''}
                                ${user.is_member ? '<span class="badge badge-member">íšŒì›</span>' : ''}
                            </td>
                            <td>${user.purchase_count}ê±´</td>
                            <td>â‚©${user.total_spent.toLocaleString()}</td>
                            <td>
                                <button class="action-btn action-btn-primary" onclick="viewUser(${user.id})">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('users-body').innerHTML = `
                    <tr><td colspan="9" class="error-message">${error.message}</td></tr>
                `;
            }
        }
        
        // êµ¬ë§¤ ë‚´ì—­ ë¡œë“œ
        async function loadPurchases() {
            try {
                const data = await apiRequest('/api/admin/purchases');
                const tbody = document.getElementById('purchases-body');
                
                if (data.purchases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">êµ¬ë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = data.purchases.map(p => `
                        <tr>
                            <td>${p.id}</td>
                            <td>${p.username}</td>
                            <td>${p.email}</td>
                            <td>${p.prompt_title}</td>
                            <td>â‚©${p.price.toLocaleString()}</td>
                            <td>${p.purchased_at}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('êµ¬ë§¤ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('purchases-body').innerHTML = `
                    <tr><td colspan="6" class="error-message">${error.message}</td></tr>
                `;
            }
        }
        
        // ê²°ì œ ë‚´ì—­ ë¡œë“œ
        async function loadPayments() {
            try {
                const data = await apiRequest('/api/admin/payments');
                const tbody = document.getElementById('payments-body');
                
                if (data.payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = data.payments.map(p => `
                        <tr>
                            <td>${p.order_id}</td>
                            <td>${p.username}</td>
                            <td>${p.payment_method}</td>
                            <td>${p.item_name}</td>
                            <td>â‚©${p.amount.toLocaleString()}</td>
                            <td>
                                ${p.status === 'completed' ? '<span class="badge badge-completed">ì™„ë£Œ</span>' : ''}
                                ${p.status === 'pending' ? '<span class="badge badge-pending">ëŒ€ê¸°ì¤‘</span>' : ''}
                                ${p.status === 'refunded' ? '<span class="badge badge-refunded">í™˜ë¶ˆ</span>' : ''}
                            </td>
                            <td>${p.created_at}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('ê²°ì œ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('payments-body').innerHTML = `
                    <tr><td colspan="7" class="error-message">${error.message}</td></tr>
                `;
            }
        }
        
        // ì‚¬ìš©ì ìƒì„¸ë³´ê¸°
        async function viewUser(userId) {
            try {
                const user = await apiRequest(`/api/admin/users/${userId}`);
                alert(`ì‚¬ìš©ì ì •ë³´:\n\nì´ë¦„: ${user.username}\nì´ë©”ì¼: ${user.email}\nì „í™”ë²ˆí˜¸: ${user.phone || '-'}\nìƒë…„ì›”ì¼: ${user.birthdate || '-'}\nê°€ì…ì¼: ${user.created_at}\nì´ êµ¬ë§¤: ${user.purchases.length}ê±´\nì´ ì§€ì¶œ: â‚©${user.total_spent.toLocaleString()}`);
            } catch (error) {
                alert('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('auth_token');
                window.location.href = '/';
            }
        }
        
        // ì´ˆê¸°í™”
        async function init() {
            try {
                const user = await apiRequest('/api/user/info');
                document.getElementById('admin-info').textContent = `${user.user.username} (${user.user.email})`;
                
                // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
                loadDashboard();
            } catch (error) {
                alert('ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ' + error.message);
                window.location.href = '/';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>
